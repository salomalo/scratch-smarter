var WordPointsHooks;!function(a){WordPointsHooks={init:function(){var b,c,d=this,e=a(".hooks-chooser"),f=e.find(".hooks-chooser-points-types"),g=a("div.hooks-sortables"),h="undefined"!=typeof isRtl&&isRtl,i=h?"marginRight":"marginLeft";a("#hooks-right").children(".hooks-holder-wrap").children(".points-type-name").click(function(){var b=a(this),c=b.parent();c.hasClass("closed")?(c.removeClass("closed"),b.siblings(".hooks-sortables").sortable("refresh")):c.addClass("closed")}),a("#hooks-left").children(".hooks-holder-wrap").children(".points-type-name").click(function(){a(this).parent().toggleClass("closed")}),g.each(function(){if(a(this).parent().hasClass("inactive"))return!0;var b=50,c=a(this).children(".hook").length;b+=parseInt(48*c,10),a(this).css("minHeight",b+"px")}),a(document.body).bind("click.hooks-toggle",function(b){var c,d,e,f=a(b.target),g={};f.parents(".hook-top").length&&!f.parents("#available-hooks").length?(c=f.closest("div.hook"),d=c.children(".hook-inside"),e=parseInt(c.find("input.hook-width").val(),10),d.is(":hidden")?(e>250&&d.closest("div.hooks-sortables").length&&(g.width=e+30+"px",d.closest("div.hook-liquid-right").length&&(g[i]=235-e+"px"),c.css(g)),WordPointsHooks.fixLabels(c),d.slideDown("fast")):d.slideUp("fast",function(){c.css({width:"",margin:""})}),b.preventDefault()):f.hasClass("hook-control-save")?f.parent().parent().parent().parent().hasClass("wordpoints-points-add-new")||(WordPointsHooks.save(f.closest("div.hook"),0,1,0),b.preventDefault()):f.hasClass("hook-control-remove")?(WordPointsHooks.save(f.closest("div.hook"),1,1,0),b.preventDefault()):f.hasClass("hook-control-close")&&(WordPointsHooks.close(f.closest("div.hook")),b.preventDefault())}),g.children(".hook").each(function(){WordPointsHooks.appendTitle(this),a("p.hook-error",this).length&&a("a.hook-action",this).click()}),a("#hook-list").children(".hook").draggable({connectToSortable:"div.hooks-sortables",handle:"> .hook-top > .hook-title",distance:2,helper:"clone",zIndex:100,containment:"document",start:function(b,e){var f=a(this).find(".hooks-chooser");e.helper.find("div.hook-description").hide(),c=this.id,f.length&&(a("#wpbody-content").append(f.hide()),e.helper.find(".hooks-chooser").remove(),d.clearHookSelection())},stop:function(){b&&a(b).hide(),b=""}}),g.sortable({placeholder:"hook-placeholder",items:"> .hook:not( .points-settings )",handle:"> .hook-top > .hook-title",cursor:"move",distance:2,containment:"document",start:function(b,c){var d,e=a(this),f=e.parent(),g=c.item.children(".hook-inside");"block"===g.css("display")&&(g.hide(),a(this).sortable("refreshPositions")),f.hasClass("closed")||(d=c.item.hasClass("ui-draggable")?e.height():1+e.height(),e.css("min-height",d+"px"))},stop:function(e,f){var g,h,i,j,k,l,m=f.item,n=c;return m.hasClass("deleting")?(d.save(m,1,0,1),void m.remove()):(g=m.find("input.add_new").val(),h=m.find("input.multi_number").val(),m.attr("style","").removeClass("ui-draggable"),c="",g&&("multi"===g?(m.html(m.html().replace(/<[^<>]+>/g,function(a){return a.replace(/__i__|%i%/g,h)})),m.attr("id",n.replace("__i__",h)),h++,a("div#"+n).find("input.multi_number").val(h)):"single"===g&&(m.attr("id","new-"+n),b="div#"+n),d.save(m,0,0,1),m.find("input.add_new").val("")),i=m.parent(),i.parent().hasClass("closed")&&(i.parent().removeClass("closed"),j=i.children(".hook"),j.length>1&&(k=j.get(0),l=m.get(0),k.id&&l.id&&k.id!==l.id&&a(k).before(m))),void(g?m.find("a.hook-action").trigger("click"):d.saveOrder(i.attr("id"))))},activate:function(){a(this).parent().addClass("hook-hover")},deactivate:function(){a(this).css("min-height","").parent().removeClass("hook-hover")}}).sortable("option","connectWith","div.hooks-sortables"),a("#available-hooks").droppable({tolerance:"pointer",accept:function(b){return"hook-list"!==a(b).parent().attr("id")},drop:function(b,c){c.draggable.addClass("deleting"),a("#removing-hook").hide().children("span").html("")},over:function(b,c){c.draggable.addClass("deleting"),a("div.hook-placeholder").hide(),c.draggable.hasClass("ui-sortable-helper")&&a("#removing-hook").show().children("span").html(c.draggable.find("div.hook-title").children("h4").html())},out:function(b,c){c.draggable.removeClass("deleting"),a("div.hook-placeholder").show(),a("#removing-hook").hide().children("span").html("")}}),a("#hooks-right .hooks-holder-wrap").each(function(b,c){var d=a(c),e=d.find(".points-type-name h3").text(),g=d.find(".hooks-sortables").attr("id"),h=a('<li tabindex="0">').text(a.trim(e));d.hasClass("new-points-type")||(0===b&&h.addClass("hooks-chooser-selected"),f.append(h),h.data("pointsTypeId",g))}),a("#available-hooks .hook .hook-title").on("click.hooks-chooser",function(){var b=a(this).closest(".hook");b.hasClass("hook-in-question")||a("#hooks-left").hasClass("chooser")?d.closeChooser():(d.clearHookSelection(),a("#hooks-left").addClass("chooser"),b.addClass("hook-in-question").children(".hook-description").after(e),e.slideDown(300,function(){f.find(".hooks-chooser-selected").focus()}),f.find("li").on("focusin.hooks-chooser",function(){f.find(".hooks-chooser-selected").removeClass("hooks-chooser-selected wp-ui-highlight"),a(this).addClass("hooks-chooser-selected wp-ui-highlight")}))}),e.on("click.hooks-chooser",function(b){var c=a(b.target);c.hasClass("button-primary")?(d.addHook(e),d.closeChooser()):c.hasClass("button-secondary")&&d.closeChooser()}).on("keyup.hooks-chooser",function(b){b.which===a.ui.keyCode.ENTER?a(b.target).hasClass("button-secondary")?d.closeChooser():(d.addHook(e),d.closeChooser()):b.which===a.ui.keyCode.ESCAPE&&d.closeChooser()})},saveOrder:function(b){b&&a("#"+b).closest("div.hooks-holder-wrap").find(".spinner:first").addClass("is-active");var c={action:"wordpoints-points-hooks-order",savehooks:a("#_wpnonce_hooks").val(),points_types:[]};a("div.hooks-sortables").each(function(){a(this).sortable&&(c["points_types["+a(this).attr("id")+"]"]=a(this).sortable("toArray").join(","))}),a.post(ajaxurl,c,function(){a(".spinner ").removeClass("is-active")}),this.resize()},save:function(b,c,d,e){var f,g=b.closest("div.hooks-sortables").attr("id"),h=b.find("form").serialize();b=a(b),a(".spinner",b).addClass("is-active"),f={action:"save-wordpoints-points-hook",savehooks:a("#_wpnonce_hooks").val(),points_type:g},c&&(f.delete_hook=1),h+="&"+a.param(f),a.post(ajaxurl,h,function(f){var g;c?(a("input.hook_number",b).val()||(g=a("input.hook-id",b).val(),a("#available-hooks").find("input.hook-id").each(function(){a(this).val()===g&&a(this).closest("div.hook").show()})),d?(e=0,b.slideUp("fast",function(){a(this).remove(),WordPointsHooks.saveOrder()})):(b.remove(),WordPointsHooks.resize())):(a(".spinner").removeClass("is-active"),f&&f.length>2&&(a("div.hook-content",b).html(f),WordPointsHooks.appendTitle(b),WordPointsHooks.fixLabels(b))),e&&WordPointsHooks.saveOrder()})},appendTitle:function(b){var c,d;if(d=a(".wordpoints-append-to-hook-title",b),0===d.length){if(c=a('input[id*="-title"]',b).val(),!c)return}else c=d.is("select")?d.find(":selected").text():d.val();a(".in-hook-title",b).text(": "+c)},resize:function(){a("div.hooks-sortables").each(function(){if(a(this).parent().hasClass("inactive"))return!0;var b=50,c=a(this).children(".hook").length;b+=parseInt(48*c,10),a(this).css("minHeight",b+"px")})},fixLabels:function(b){b.children(".hook-inside").find("label").each(function(){var b=a(this).attr("for");b&&b===a("input",this).attr("id")&&a(this).removeAttr("for")})},close:function(a){a.children(".hook-inside").slideUp("fast",function(){a.css({width:"",margin:""})})},addHook:function(b){var c,d,e,f,g=b.find(".hooks-chooser-selected").data("pointsTypeId"),h=a("#"+g);c=a("#available-hooks").find(".hook-in-question").clone(),d=c.attr("id"),e=c.find("input.add_new").val(),f=c.find("input.multi_number").val(),c.find(".hooks-chooser").remove(),"multi"===e?(c.html(c.html().replace(/<[^<>]+>/g,function(a){return a.replace(/__i__|%i%/g,f)})),c.attr("id",d.replace("__i__",f)),f++,a("#"+d).find("input.multi_number").val(f)):"single"===e&&(c.attr("id","new-"+d),a("#"+d).hide()),h.closest(".hooks-holder-wrap").removeClass("closed"),h.sortable("refresh"),h.find(".points-hooks-settings-separator").after(c),WordPointsHooks.save(c,0,0,1),c.find("input.add_new").val("");var i=a(window).scrollTop(),j=i+a(window).height(),k=h.offset();k.bottom=k.top+h.outerHeight(),(i>k.bottom||j<k.top)&&a("html, body").animate({scrollTop:h.offset().top-130},200),window.setTimeout(function(){c.find(".hook-title").trigger("click")},250)},closeChooser:function(){var b=this;a(".hooks-chooser").slideUp(200,function(){a("#wpbody-content").append(this),b.clearHookSelection()})},clearHookSelection:function(){a("#hooks-left").removeClass("chooser"),a(".hook-in-question").removeClass("hook-in-question")}},a(document).ready(function(){WordPointsHooks.init()})}(jQuery);