window.wp=window.wp||{},jQuery(function(a){function b(b){var c={},d=b.serializeArray();return a.each(d,function(a,b){c[b.name]=b.value}),c}function c(b,c,d,e){var f;switch(d=d||{},d.context=e,d.data=_.extend(d.data||{},{group:a(".wordpoints-rank-group").data("slug")}),b){case"read":d.data.action="wordpoints_admin_get_ranks",d.data.nonce=a(".wordpoints-rank-group").data("nonce");break;case"create":d.data.action="wordpoints_admin_create_rank",d.data=_.extend(d.data,e.attributes);break;case"update":d.data.action="wordpoints_admin_update_rank",d.data=_.extend(d.data,e.attributes);break;case"delete":d.data.action="wordpoints_admin_delete_rank",d.data.id=e.get("id"),d.data.nonce=e.get("delete_nonce")}return f=wp.ajax.send(d)}var d,e;wp.wordpoints=wp.wordpoints||{},d=wp.wordpoints.ranks={model:{},view:{},controller:{}},d.l10n=WordPointsRanksAdminL10n,d.data=WordPointsRanksAdminData,wp.wordpoints.ranks.model.Rank=Backbone.Model.extend({defaults:function(){return{name:"",order:e.nextOrder()}},validate:function(b){return""===a.trim(b.name)?{field:"name",message:d.l10n.emptyName}:(b.order=parseInt(b.order,10),void((isNaN(b.order)||b.order<0)&&(b.order=e.nextOrder())))},sync:function(a,b,d){return c(a,b,d,this)}}),d.model.RankGroup=Backbone.Collection.extend({model:d.model.Rank,nextOrder:function(){return this.length?parseInt(this.sort().last().get("order"),10)+1:0},comparator:"order",sync:function(a,b,d){return c(a,b,d,this)}}),e=new d.model.RankGroup,d.model.RankType=Backbone.Model.extend({defaults:function(){return{name:""}}}),d.view.Rank=Backbone.View.extend({tagName:"li",events:function(){var a={"click .delete":"confirmDelete","click .save":"save","click .cancel":"cancel","click .close":"close","click .edit":"edit","change form *":"lockOpen"};return"oninput"in document.createElement("input")?a["input input"]="lockOpen":a["keyup input"]="maybeLockOpen",a},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"sync",this.showSuccess),this.listenTo(this.model,"error",this.showError),this.listenTo(this.model,"invalid",this.showError),this.template=_.template(a(".rank-template_"+this.model.get("type").replace(/[^a-z0-9-_]/gi,"")).html())},render:function(){return this.$el.html(this.template(this.model.toJSON())).addClass("wordpoints-rank").removeClass("changed"),this},edit:function(){this.$("form").slideDown("fast"),this.$el.addClass("editing")},close:function(a){a.preventDefault(),this.$("form").slideUp("fast"),this.$el.removeClass("editing"),this.$(".success").hide()},maybeLockOpen:function(b){var c=a(b.target);c.val()!==this.model.get(c.attr("name"))&&this.lockOpen()},lockOpen:function(){this.$el.addClass("changed"),this.$(".save").prop("disabled",!1),this.$(".success").fadeOut()},cancel:function(a){return a.preventDefault(),this.$el.hasClass("new")?(e.trigger("cancel-add-new"),void this.remove()):void this.render()},save:function(a){a.preventDefault(),this.wait(),this.$(".save").prop("disabled",!0),this.model.save(b(this.$("form")),{wait:!0})},wait:function(){this.$(".spinner-overlay").show(),this.$(".err").slideUp()},confirmDelete:function(b){var c=a("<div></div>"),e=this;b.preventDefault(),c.attr("title",d.l10n.confirmTitle).append(a("<p></p>").text(d.l10n.confirmAboutTo)).append(a("<p></p>").append(a("<b></b>").text(this.model.get("name")))).append(a("<p></p>").text(d.l10n.confirmDelete)).dialog({dialogClass:"wp-dialog wordpoints-delete-rank-dialog",resizable:!1,draggable:!1,height:"auto",modal:!0,buttons:[{text:d.l10n.cancelText,"class":"button-secondary",click:function(){a(this).dialog("close")}},{text:d.l10n.deleteText,"class":"button-primary",click:function(){a(this).dialog("close"),e.destroy()}}]})},destroy:function(){this.wait(),this.model.destroy({wait:!0})},showError:function(b,c,e){var f,g,h;if(this.$(".spinner-overlay").hide(),!e.context||e.context.collection||e.context.isNew&&e.context.isNew())return g=this.$(".messages .err"),f=d.l10n.unexpectedError,c.message&&(f=c.message,c.data&&c.data.field&&(h=this.$('[name="'+c.data.field.replace(/[^a-z0-9-_]/gi,"")+'"]'),0!==h.length))?void h.before(a('<div class="message err"></div>').text(f).show()):void g.text(f).fadeIn()},showSuccess:function(){this.$(".success").text(d.l10n.changesSaved).slideDown(),this.$el.removeClass("new")}}),d.view.Group=Backbone.View.extend({el:a(".wordpoints-rank-group-container"),events:{"click .add-rank":"initAddRank"},initialize:function(){this.$addRank=this.$(".add-rank"),this.$rankTypes=this.$(".wordpoints-rank-types select"),1===this.$rankTypes.children("option").length&&this.$(".wordpoints-rank-types").hide(),this.$addRank.prop("disabled",!1),this.listenTo(e,"add",this.addOne),this.listenTo(e,"reset",this.addAll),this.listenTo(e,"error",this.showError),this.listenTo(e,"cancel-add-new",this.cancelAddRank),this.listenTo(e,"sync",this.cancelAddRank),e.reset(d.data.ranks[this.$(".wordpoints-rank-group").data("slug")])},addOne:function(a){var b=new d.view.Rank({model:a}),c=b.render().el,e=""===a.get("name");e&&(b.edit(),b.lockOpen(),b.$el.addClass("new")),this.$(".wordpoints-rank-group").append(c),e&&b.$(":input:visible").first().focus()},addAll:function(){e.each(this.addOne,this),this.$(".spinner-overlay").fadeOut()},initAddRank:function(){var a,b;a=this.$rankTypes.val(),this.$addRank.prop("disabled",!0),b=this.$rankTypes.find('option[value="'+a.replace(/[^a-z0-9-_]/gi,"")+'"]').data("nonce"),e.add([new d.model.Rank({type:a,nonce:b})])},cancelAddRank:function(){this.$addRank.prop("disabled",!1)},showError:function(b,c,e){e.context.collection||a("#ranks-error-message p").text(c.message||d.l10n.unexpectedError).parent().fadeIn()}}),new d.view.Group});